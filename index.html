<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Scan Indomaret</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #preview { width: 100%; max-width: 400px; border: 1px solid #ccc; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .debug { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    .btn { padding: 6px 10px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; margin: 2px; font-size: 14px; }
    .btn:hover { background: #0056b3; }
    .active { background: #28a745 !important; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #a71d2a; }
    .btn-warning { background: #ffc107; color: black; }
    .btn-warning:hover { background: #d39e00; }
    .total-box { margin-top: 15px; font-size: 18px; font-weight: bold; }
  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
  <h2>POS Scan Indomaret</h2>
  <video id="preview" autoplay playsinline></video>
  <p>Status: <span id="status">belum dijalankan</span></p>

  <div>
    <button id="modeKasir" class="btn active" onclick="setMode('kasir')">Mode Kasir</button>
    <button id="modeRestok" class="btn" onclick="setMode('restok')">Mode Restok</button>
  </div>

  <div class="debug">
    <h3>Manual / Debug (fallback jika kamera tidak tersedia)</h3>
    <input type="text" id="manualCode" placeholder="Masukkan kode/barcode untuk simulasi">
    <button class="btn" onclick="simulateScan()">Simulasikan Scan</button>
    <button class="btn" onclick="loadDemo()">Load Demo Produk</button>
  </div>

  <h3>Produk</h3>
  <table>
    <thead>
      <tr><th>Kode</th><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr>
    </thead>
    <tbody id="productTable"></tbody>
  </table>

  <h3>Keranjang</h3>
  <table>
    <thead>
      <tr><th>Kode</th><th>Nama</th><th>Harga</th><th>Qty</th><th>Subtotal</th></tr>
    </thead>
    <tbody id="cartTable"></tbody>
  </table>

  <div class="total-box">
    Total: Rp <span id="totalBelanja">0</span>
  </div>
  <button class="btn" onclick="printInvoice()">Cetak Invoice</button>

  <script>
    const products = [];
    const cart = [];
    let currentMode = "kasir";

    function setMode(mode) {
      currentMode = mode;
      document.getElementById("modeKasir").classList.toggle("active", mode === "kasir");
      document.getElementById("modeRestok").classList.toggle("active", mode === "restok");
      document.getElementById("status").textContent = "Mode sekarang: " + mode.toUpperCase();
    }

    function formatMoney(num) {
      return new Intl.NumberFormat('id-ID').format(num);
    }

    function renderProducts() {
      const rows = products.map((p, i) =>
        `<tr>
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td>Rp ${formatMoney(p.price)}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn btn-warning" onclick="editProduct(${i})">Edit</button>
            <button class="btn btn-danger" onclick="deleteProduct(${i})">Hapus</button>
          </td>
        </tr>`
      ).join('');
      document.getElementById("productTable").innerHTML = rows || '<tr><td colspan="5">Belum ada produk</td></tr>';
    }

    function renderCart() {
      let total = 0;
      const rows = cart.map(c => {
        const subtotal = c.price * c.qty;
        total += subtotal;
        return `<tr>
          <td>${c.code}</td>
          <td>${c.name}</td>
          <td>Rp ${formatMoney(c.price)}</td>
          <td>${c.qty}</td>
          <td>Rp ${formatMoney(subtotal)}</td>
        </tr>`;
      }).join('');
      document.getElementById("cartTable").innerHTML = rows || '<tr><td colspan="5">Keranjang kosong</td></tr>';
      document.getElementById("totalBelanja").textContent = formatMoney(total);
    }

    function simulateScan() {
      const code = document.getElementById("manualCode").value.trim();
      if (!code) return alert("Masukkan kode dulu!");
      handleScanResult(code);
      document.getElementById("manualCode").value = "";
    }

    function loadDemo() {
      products.push({ code: "12345", name: "Aqua Botol 600ml", price: 5000, stock: 10 });
      products.push({ code: "67890", name: "Indomie Goreng", price: 3500, stock: 20 });
      products.push({ code: "11111", name: "Teh Kotak 200ml", price: 4000, stock: 15 });
      renderProducts();
    }

    function handleScanResult(code) {
      let p = products.find(x => x.code === code);

      if (!p) {
        const name = prompt("Nama produk baru untuk kode " + code + ":");
        const price = parseInt(prompt("Harga produk:"), 10) || 0;
        p = { code, name, price, stock: 0 };
        products.push(p);
      }

      if (currentMode === "restok") {
        p.stock++;
        document.getElementById("status").textContent = "Restok: " + p.name + " stok sekarang " + p.stock;
      } else {
        if (p.stock > 0) {
          p.stock--;
          let c = cart.find(x => x.code === code);
          if (!c) cart.push({ code, name: p.name, price: p.price, qty: 1 });
          else c.qty++;
          document.getElementById("status").textContent = "Kasir: " + p.name + " ditambahkan ke keranjang";
        } else {
          alert("Stok habis untuk " + p.name);
        }
      }

      renderProducts();
      renderCart();
    }

    function deleteProduct(index) {
      if (confirm("Yakin hapus produk ini?")) {
        products.splice(index, 1);
        renderProducts();
      }
    }

    function editProduct(index) {
      const p = products[index];
      const newName = prompt("Edit nama produk:", p.name);
      if (!newName) return;
      const newPrice = parseInt(prompt("Edit harga produk:", p.price), 10);
      if (isNaN(newPrice)) return alert("Harga tidak valid!");
      p.name = newName;
      p.price = newPrice;
      renderProducts();
      renderCart();
    }

    function printInvoice() {
      let invoiceWindow = window.open("", "_blank");
      let total = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
      invoiceWindow.document.write(`
        <html>
          <head><title>Invoice</title></head>
          <body>
            <h2>Invoice Belanja</h2>
            <table border="1" cellpadding="5" cellspacing="0" width="100%">
              <tr><th>Kode</th><th>Nama</th><th>Harga</th><th>Qty</th><th>Subtotal</th></tr>
              ${cart.map(c => `
                <tr>
                  <td>${c.code}</td>
                  <td>${c.name}</td>
                  <td>Rp ${formatMoney(c.price)}</td>
                  <td>${c.qty}</td>
                  <td>Rp ${formatMoney(c.price * c.qty)}</td>
                </tr>
              `).join('')}
            </table>
            <h3>Total: Rp ${formatMoney(total)}</h3>
            <p>Terima kasih sudah berbelanja üôè</p>
            <script>window.print();<\/script>
          </body>
        </html>
      `);
      invoiceWindow.document.close();
    }

    async function startCamera() {
      try {
        const codeReader = new ZXing.BrowserBarcodeReader();
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");
        if (videoDevices.length === 0) throw new Error("Tidak ada kamera ditemukan");
        const backCam = videoDevices.find(d => d.label.toLowerCase().includes("back")) || videoDevices[0];

        codeReader.decodeFromVideoDevice(backCam.deviceId, "preview", (result, err) => {
          if (result) handleScanResult(result.text);
          if (err && !(err instanceof ZXing.NotFoundException)) console.error(err);
        });
      } catch (e) {
        document.getElementById("status").textContent = "Error: " + e.message;
      }
    }

    startCamera();
  </script>
</body>
</html>
